<!DOCTYPE html>
<html>
<head>
    <title>StudyGuru WebSocket Example</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .user-message { background-color: #e3f2fd; }
        .ai-message { background-color: #f3e5f5; }
        .system-message { background-color: #e8f5e8; }
        .loading { color: #666; font-style: italic; }
        .error { background-color: #ffebee; color: #c62828; }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
        #messageInput { width: 70%; padding: 10px; }
        #sendButton { width: 25%; padding: 10px; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>StudyGuru WebSocket Chat</h1>
        <div id="status">Connecting...</div>
        <div id="messages"></div>
        <div>
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script>
        class StudyGuruWebSocket {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.pendingMessages = new Map(); // Track pending messages
                this.init();
            }

            init() {
                this.connect();
                this.setupEventListeners();
            }

            connect() {
                // Replace with your actual JWT token
                const token = localStorage.getItem('jwt_token') || 'your-jwt-token-here';
                
                this.ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);
                
                this.ws.onopen = () => {
                    this.isConnected = true;
                    this.updateStatus('Connected', 'system-message');
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = () => {
                    this.isConnected = false;
                    this.updateStatus('Disconnected', 'error');
                    // Reconnect after 3 seconds
                    setTimeout(() => this.connect(), 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateStatus('Connection error', 'error');
                };
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'connected':
                        this.updateStatus(`Connected as user: ${message.data.user_id}`, 'system-message');
                        break;
                    
                    case 'message_received':
                        this.handleMessageReceived(message.data);
                        break;
                    
                    case 'ai_response_ready':
                        this.handleAIResponseReady(message.data);
                        break;
                    
                    case 'pong':
                        console.log('Pong received:', message.data);
                        break;
                    
                    case 'error':
                        this.addMessage(`Error: ${message.data}`, 'error');
                        break;
                    
                    default:
                        console.log('Unknown message type:', message);
                }
            }

            handleMessageReceived(data) {
                // Find the pending message and update its status
                const pendingMessage = this.pendingMessages.get(data.conversation_id);
                if (pendingMessage) {
                    pendingMessage.status = 'received';
                    pendingMessage.element.innerHTML = `
                        <strong>You:</strong> ${pendingMessage.content}
                        <br><small class="loading">✓ Message received, processing...</small>
                    `;
                }
            }

            handleAIResponseReady(data) {
                // Find the pending message and show AI response
                const pendingMessage = this.pendingMessages.get(data.interaction_id);
                if (pendingMessage) {
                    pendingMessage.status = 'completed';
                    pendingMessage.element.innerHTML = `
                        <strong>You:</strong> ${pendingMessage.content}
                        <br><small>✓ Message received</small>
                    `;
                    
                    // Add AI response
                    this.addMessage(`<strong>StudyGuru AI:</strong> ${data.ai_response}`, 'ai-message');
                    
                    // Remove from pending
                    this.pendingMessages.delete(data.interaction_id);
                }
            }

            sendMessage(content) {
                if (!this.isConnected) {
                    this.addMessage('Not connected to server', 'error');
                    return;
                }

                // Add user message to UI immediately
                const messageElement = this.addMessage(`<strong>You:</strong> ${content}`, 'user-message');
                
                // Add loading state
                messageElement.innerHTML = `
                    <strong>You:</strong> ${content}
                    <br><small class="loading">Sending...</small>
                `;

                // Store pending message
                const tempId = Date.now().toString();
                this.pendingMessages.set(tempId, {
                    element: messageElement,
                    content: content,
                    status: 'sending'
                });

                // Send GraphQL mutation (you'll need to implement this)
                this.sendGraphQLMutation(content, tempId);
            }

            async sendGraphQLMutation(message, tempId) {
                try {
                    const response = await fetch('/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                        },
                        body: JSON.stringify({
                            query: `
                                mutation DoConversation($input: DoConversationInput!) {
                                    do_conversation(input: $input) {
                                        success
                                        message
                                        interaction_id
                                        is_new_interaction
                                        ai_response
                                    }
                                }
                            `,
                            variables: {
                                input: {
                                    message: message,
                                    max_tokens: 1000
                                }
                            }
                        })
                    });

                    const result = await response.json();
                    
                    if (result.data?.do_conversation?.success) {
                        // Update pending message with interaction_id
                        const pendingMessage = this.pendingMessages.get(tempId);
                        if (pendingMessage) {
                            this.pendingMessages.delete(tempId);
                            this.pendingMessages.set(result.data.do_conversation.interaction_id, pendingMessage);
                        }
                    } else {
                        // Handle error
                        const pendingMessage = this.pendingMessages.get(tempId);
                        if (pendingMessage) {
                            pendingMessage.element.innerHTML = `
                                <strong>You:</strong> ${pendingMessage.content}
                                <br><small class="error">Error: ${result.data?.do_conversation?.message || 'Unknown error'}</small>
                            `;
                            this.pendingMessages.delete(tempId);
                        }
                    }
                } catch (error) {
                    console.error('GraphQL error:', error);
                    const pendingMessage = this.pendingMessages.get(tempId);
                    if (pendingMessage) {
                        pendingMessage.element.innerHTML = `
                            <strong>You:</strong> ${pendingMessage.content}
                            <br><small class="error">Network error</small>
                        `;
                        this.pendingMessages.delete(tempId);
                    }
                }
            }

            addMessage(content, className) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${className}`;
                messageDiv.innerHTML = content;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                return messageDiv;
            }

            updateStatus(message, className) {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = message;
                statusDiv.className = className;
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                const sendMessage = () => {
                    const content = messageInput.value.trim();
                    if (content) {
                        this.sendMessage(content);
                        messageInput.value = '';
                    }
                };

                sendButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });

                // Send ping every 30 seconds to keep connection alive
                setInterval(() => {
                    if (this.isConnected) {
                        this.ws.send(JSON.stringify({ type: 'ping', data: 'keepalive' }));
                    }
                }, 30000);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new StudyGuruWebSocket();
        });
    </script>
</body>
</html>
